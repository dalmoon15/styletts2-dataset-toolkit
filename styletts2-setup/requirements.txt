# StyleTTS2 Dataset Toolkit - Battle-Tested Requirements
# Last Updated: November 2025
# Tested on: Windows 10/11, Python 3.10, RTX 3060 12GB
# 
# Installation instructions: See docs/STYLETTS2_INSTALLATION.md
# Troubleshooting: See docs/TROUBLESHOOTING.md

# ============================================================================
# INSTALLATION ORDER (CRITICAL - Follow exactly)
# ============================================================================
# 
# Step 1: Install PyTorch with CUDA FIRST
# ----------------------------------------
# For CUDA 12.1 (Tested and Working):
#   pip install torch==2.5.1+cu121 torchaudio==2.5.1+cu121 torchvision==0.20.1+cu121 --index-url https://download.pytorch.org/whl/cu121
#
# For CUDA 12.4 (If available - includes security fix CVE-2025-32434):
#   pip install torch==2.6.0+cu124 torchaudio==2.6.0+cu124 torchvision==0.21.0+cu124 --index-url https://download.pytorch.org/whl/cu124
#
# Verify CUDA installation:
#   python -c "import torch; print(f'CUDA: {torch.cuda.is_available()}')"
#
# Step 2: Install this requirements file
# ----------------------------------------
#   pip install -r requirements.txt
#
# Step 3: Install monotonic_align from GitHub (REQUIRED for training)
# --------------------------------------------------------------------
#   pip install git+https://github.com/resemble-ai/monotonic_align.git
#
# Step 4: For WebUI only - Install styletts2 package (OPTIONAL)
# --------------------------------------------------------------
#   pip install styletts2==0.1.6 --no-deps
#   
#   WARNING: Must use --no-deps to avoid dependency downgrades!
#   The styletts2 PyPI package has outdated dependency pins that will
#   break huggingface-hub, transformers, and gradio if installed normally.

# ============================================================================
# PyTorch (Install separately - see Step 1 above)
# ============================================================================
# Do NOT uncomment these - they're here for documentation only
# torch==2.5.1+cu121
# torchaudio==2.5.1+cu121  
# torchvision==0.20.1+cu121

# ============================================================================
# Core Dependencies (Tested Versions)
# ============================================================================
PyYAML==6.0.3
munch==4.0.0
numpy==1.26.4
scipy==1.15.3

# ============================================================================
# Audio Processing
# ============================================================================
librosa==0.10.2.post1
soundfile==0.12.1
audioread==3.1.0
pydub==0.25.1           # For segmentation in WebUI
soxr==0.1.0             # High-quality resampling

# ============================================================================
# Text Processing & Normalization (CRITICAL)
# ============================================================================
num2words==0.5.14       # CRITICAL: Converts digits to words (e.g., "25" â†’ "twenty five")
                        # StyleTTS2 has 178-token vocabulary - only letters + punctuation
                        # Without this, training will crash on digit tokens!
nltk==3.9.2             # Required for tokenization
phonemizer==3.2.1       # Requires espeak-ng system package
inflect==7.0.0          # Text normalization utilities
unidecode==1.3.8        # Unicode to ASCII conversion

# ============================================================================
# Machine Learning / Transformers
# ============================================================================
transformers==4.40.2    # Tested with torch 2.5.1
                        # Note: 4.57+ requires torch 2.6+ (security fix)
                        # Upgrade together if moving to torch 2.6
accelerate==0.25.0
huggingface-hub==0.19.4 # Works with gradio 4.44.1
                        # WARNING: styletts2 package pins to <0.20
                        # If using styletts2 package, install with --no-deps
safetensors==0.6.2
einops==0.7.0
einops-exts==0.0.4

# ============================================================================
# Web UI (Gradio)
# ============================================================================
gradio==4.44.1          # Tested and stable
                        # Note: Newer versions (5.x) may have breaking changes
ffmpy==1.0.0            # Required by gradio for audio

# ============================================================================
# Transcription (Dataset Preparation)
# ============================================================================
openai-whisper==20250625  # GPU-accelerated transcription
                          # Also installs: tiktoken, more-itertools

# ============================================================================
# Training & Monitoring
# ============================================================================
tensorboard>=2.14.0     # HIGHLY RECOMMENDED for training visualization
                        # View with: tensorboard --logdir=Models/LJSpeech
click==8.3.0
tqdm==4.67.1

# ============================================================================
# Analysis & Visualization (For Batch Inference)
# ============================================================================
pandas==2.3.3           # CSV results analysis
matplotlib==3.10.0      # Plotting RTF graphs

# ============================================================================
# Utilities
# ============================================================================
requests==2.32.5
pillow==10.4.0
typing_extensions==4.15.0

# ============================================================================
# KNOWN CONFLICTS & RESOLUTIONS
# ============================================================================
#
# 1. huggingface-hub Version Conflict
# ------------------------------------
# PROBLEM: styletts2 PyPI package pins huggingface-hub<0.20
#          This conflicts with gradio 4.44+ and transformers 4.40+
# 
# SOLUTION: Install styletts2 with --no-deps:
#   pip install styletts2==0.1.6 --no-deps
#
# CONTEXT: The styletts2 package is only needed for pretrained inference.
#          For fine-tuning, you use the StyleTTS2 training scripts directly.
#
# 2. langchain Version Lock
# --------------------------
# PROBLEM: langchain >=0.1.0 removed built-in text_splitter module
#          styletts2 package expects old structure
#
# SOLUTION: If using styletts2 package for pretrained inference:
#   pip install "langchain<0.1.0"
#   pip uninstall langchain-text-splitters -y
#
# ALTERNATIVE: Don't use styletts2 package, use training scripts directly
#
# 3. PyTorch Version Compatibility
# ---------------------------------
# TESTED: torch 2.5.1+cu121 (stable, production-ready)
# NEWER: torch 2.6.0+cu124 (includes CVE-2025-32434 fix)
#
# If upgrading to torch 2.6.0:
#   - Also upgrade transformers to 4.57.1+
#   - Test all functionality before deploying
#
# 4. monotonic_align Installation
# --------------------------------
# PROBLEM: PyPI package is incomplete/broken
#
# SOLUTION: Always install from GitHub:
#   pip install git+https://github.com/resemble-ai/monotonic_align.git
#
# This requires:
#   - Microsoft C++ Build Tools (Windows)
#   - Cython (auto-installed)
#
# 5. Windows DataLoader Issues
# -----------------------------
# PROBLEM: num_workers > 0 causes process fork bomb on Windows
#
# SOLUTION: In config_ft.yml, set:
#   loader_params:
#     train_num_workers: 0
#     val_num_workers: 0
#
# Our meldataset.py patch auto-detects Windows and forces this.
#
# 6. espeak-ng System Dependency
# -------------------------------
# PROBLEM: phonemizer requires espeak-ng system binary
#
# SOLUTION: Install espeak-ng:
#   Windows: https://github.com/espeak-ng/espeak-ng/releases
#   Add to PATH or set PHONEMIZER_ESPEAK_LIBRARY environment variable

# ============================================================================
# INSTALLATION VERIFICATION
# ============================================================================
#
# After installation, verify everything works:
#
# 1. Check PyTorch CUDA:
#    python -c "import torch; print(f'CUDA: {torch.cuda.is_available()}')"
#
# 2. Check core imports:
#    python -c "import librosa, gradio, whisper, num2words; print('OK')"
#
# 3. Check monotonic_align (if training):
#    python -c "import monotonic_align; print('OK')"
#
# 4. Launch WebUI to test full stack:
#    python styletts2_webui.py
#
# 5. Check espeak-ng:
#    espeak-ng --version

# ============================================================================
# OPTIONAL DEPENDENCIES (Not Required but Useful)
# ============================================================================
#
# For Jupyter notebook experimentation:
#   jupyter>=1.0.0
#   ipython>=8.12.0
#
# For code quality (development):
#   ruff>=0.14.0        # Fast linter
#   mypy>=1.0.0         # Type checking
#
# For testing:
#   pytest>=7.4.0
#   pytest-cov>=4.1.0

# ============================================================================
# MEMORY USAGE ESTIMATES (RTX 3060 12GB)
# ============================================================================
#
# Training (batch_size=8):    ~10GB VRAM
# Inference (diffusion=5):    ~2GB VRAM
# WebUI Idle:                 ~1GB VRAM
# Whisper Base:               ~1GB VRAM
# Whisper Medium:             ~5GB VRAM
#
# Total for full pipeline:    ~11GB VRAM (comfortable on 12GB GPU)

# ============================================================================
# PACKAGE SIZE EXPECTATIONS
# ============================================================================
#
# Full installation size: ~8-10 GB including:
#   - PyTorch + CUDA: ~5GB
#   - Transformers models: ~2GB (downloaded on first use)
#   - Other packages: ~1-2GB
#
# Pretrained StyleTTS2 models (not in this requirements):
#   - LibriTTS checkpoint: ~1.9GB (download separately)
#   - LJSpeech checkpoint: ~1.9GB (download separately)

# ============================================================================
# SECURITY NOTES
# ============================================================================
#
# 1. PyTorch CVE-2025-32434:
#    Fixed in torch 2.6.0+. Affects torch.load() with malicious .pth files.
#    Mitigation: Only load checkpoints from trusted sources.
#
# 2. Regular updates:
#    Check for security updates: pip list --outdated
#    Update cautiously: Test in dev environment first

# ============================================================================
# For detailed documentation:
# ============================================================================
# - Installation: docs/STYLETTS2_INSTALLATION.md
# - Pretrained models: docs/PRETRAINED_MODELS.md
# - Troubleshooting: docs/TROUBLESHOOTING.md
# - Windows issues: Comprehensive Windows fixes in patches/
